name: KernelSU Patcher Action
on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: 'URL to firmware (zip/payload.bin)'
        required: true
        type: string

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          DUMP_URL=$(curl -s https://api.github.com/repos/ssut/payload-dumper-go/releases/latest | jq -r '.assets[] | select(.name | contains("linux_amd64")) | .browser_download_url')
          wget -q $DUMP_URL -O dumper.tar.gz && tar -xzf dumper.tar.gz
          sudo mv payload-dumper-go /usr/local/bin/

          wget -q https://raw.githubusercontent.com/handingslider/HyperOS-Port-Python/refs/heads/main/bin/linux/x86_64/magiskboot
          chmod +x magiskboot
          sudo mv magiskboot /usr/local/bin/

          KSU_URL=$(curl -s https://api.github.com/repos/tiann/KernelSU/releases/latest | jq -r '.assets[] | select(.name | contains("ksud-x86_64-unknown-linux-musl")) | .browser_download_url')
          wget -q $KSU_URL -O ksud
          chmod +x ksud
          sudo mv ksud /usr/local/bin/

      - name: Extract & Detect
        id: process
        run: |
          mkdir -p output
          wget -q "${{ github.event.inputs.firmware_url }}" -O firmware.zip
          
          if payload-dumper-go -l firmware.zip | grep -q "vendor_boot"; then
            payload-dumper-go -o output/ -p vendor_boot firmware.zip
            find output/ -name "vendor_boot.img" -exec mv {} ./vendor_boot.img \;
            cp vendor_boot.img check_kmi.img
          fi
          
          if payload-dumper-go -l firmware.zip | grep -q "init_boot"; then
            payload-dumper-go -o output/ -p init_boot firmware.zip
            find output/ -name "init_boot.img" -exec mv {} ./init_boot.img \;
            [ ! -f check_kmi.img ] && cp init_boot.img check_kmi.img
            echo "target_primary=init_boot.img" >> $GITHUB_OUTPUT
          else
            payload-dumper-go -o output/ -p boot firmware.zip
            find output/ -name "boot.img" -exec mv {} ./boot.img \;
            [ ! -f check_kmi.img ] && cp boot.img check_kmi.img
            echo "target_primary=boot.img" >> $GITHUB_OUTPUT
          fi

      - name: Resolve KMI
        id: kmi_logic
        run: |
          magiskboot unpack check_kmi.img
          
          if [ -f kernel ]; then
             KMI=$(strings kernel | grep -E "android[0-9]+-[0-9]+\.[0-9]+" | head -n 1 | cut -d' ' -f1)
          fi
          
          if [ -z "$KMI" ]; then
            KMI=$(strings check_kmi.img | grep -E "android[0-9]+-[0-9]+\.[0-9]+" | head -n 1 | cut -d' ' -f1)
          fi

          echo "Detected KMI: $KMI"
          echo "kmi=$KMI" >> $GITHUB_OUTPUT
          
          if [[ "$KMI" == *"6.6"* || "$KMI" == *"6.12"* ]]; then
            echo "final_target=vendor_boot.img" >> $GITHUB_OUTPUT
          else
            echo "final_target=${{ steps.process.outputs.target_primary }}" >> $GITHUB_OUTPUT
          fi

      - name: Patch with ksud
        run: |
          TARGET="${{ steps.kmi_logic.outputs.final_target }}"
          KMI_VAL="${{ steps.kmi_logic.outputs.kmi }}"
          ksud boot-patch -b "$TARGET" --kmi "$KMI_VAL"
          mv "$TARGET" "ksu_patched_${KMI_VAL}.img"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: KSU-Patched-${{ steps.kmi_logic.outputs.kmi }}
          path: ksu_patched_*.img
