name: KernelSU Auto Root (OTA ZIP Support)

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: "Direct link to firmware OTA ZIP"
        required: true
        type: string

jobs:
  root:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # ------------------------------------------------
      # Install dependencies
      # ------------------------------------------------
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y wget curl unzip xz-utils

      # ------------------------------------------------
      # Download OTA firmware ZIP
      # ------------------------------------------------
      - name: Download firmware ZIP
        run: |
          wget "${{ inputs.firmware_url }}" -O firmware.zip

      # ------------------------------------------------
      # Install payload-dumper-go
      # ------------------------------------------------
      - name: Install payload-dumper-go
        run: |
          wget https://github.com/ssut/payload-dumper-go/releases/latest/download/payload-dumper-go_linux_amd64.tar.gz
          tar -xzf payload-dumper-go_linux_amd64.tar.gz
          chmod +x payload-dumper-go

      # ------------------------------------------------
      # Extract images from ZIP directly
      # ------------------------------------------------
      - name: Extract boot/init_boot
        run: |
          mkdir extracted
          ./payload-dumper-go -o extracted firmware.zip

      # ------------------------------------------------
      # Detect correct image
      # ------------------------------------------------
      - name: Detect boot image
        run: |
          if [ -f extracted/init_boot.img ]; then
            echo "Using init_boot.img"
            echo "IMG_NAME=extracted/init_boot.img" >> $GITHUB_ENV
          elif [ -f extracted/boot.img ]; then
            echo "Using boot.img"
            echo "IMG_NAME=extracted/boot.img" >> $GITHUB_ENV
          else
            echo "❌ No boot image found"
            exit 1
          fi

      # ------------------------------------------------
      # Download latest ksud
      # ------------------------------------------------
      - name: Download latest ksud
        run: |
          curl -s https://api.github.com/repos/tiann/KernelSU/releases/latest \
          | grep browser_download_url \
          | grep ksud-x86_64-unknown-linux-musl \
          | cut -d '"' -f 4 \
          | wget -i -

          chmod +x ksud-x86_64-unknown-linux-musl
          mv ksud-x86_64-unknown-linux-musl ksud

      # ------------------------------------------------
      # Download your magiskboot binary
      # ------------------------------------------------
      - name: Download magiskboot
        run: |
          wget https://raw.githubusercontent.com/handingslider/HyperOS-Port-Python/refs/heads/main/bin/linux/x86_64/magiskboot
          chmod +x magiskboot

      # ------------------------------------------------
      # Unpack image
      # ------------------------------------------------
      - name: Unpack image
        run: |
          ./magiskboot unpack $IMG_NAME

      - name: Decompress kernel if needed
        run: |
          if [ -f kernel ]; then
            ./magiskboot decompress kernel || true
          fi

      # ------------------------------------------------
      # Detect KMI from real kernel
      # ------------------------------------------------
      - name: Detect KMI
        run: |
          if [ -f kernel_d ]; then
            TARGET_KERNEL="kernel_d"
          elif [ -f kernel ]; then
            TARGET_KERNEL="kernel"
          else
            echo "❌ Kernel not found"
            exit 1
          fi

          VERSION=$(strings $TARGET_KERNEL | grep -m1 "Linux version")
          echo "Detected: $VERSION"

          if echo "$VERSION" | grep -q "5.10"; then
            echo "KMI=5.10" >> $GITHUB_ENV
          elif echo "$VERSION" | grep -q "5.15"; then
            echo "KMI=5.15" >> $GITHUB_ENV
          elif echo "$VERSION" | grep -q "6.1"; then
            echo "KMI=6.1" >> $GITHUB_ENV
          else
            echo "❌ Unsupported KMI"
            exit 1
          fi

      # ------------------------------------------------
      # Patch with KernelSU
      # ------------------------------------------------
      - name: Patch image
        run: |
          cp $IMG_NAME original.img

          ./ksud boot-patch \
            --boot original.img \
            --kmi $KMI \
            --magiskboot ./magiskboot \
            --out rooted.img

      # ------------------------------------------------
      # Upload result
      # ------------------------------------------------
      - name: Upload rooted image
        uses: actions/upload-artifact@v4
        with:
          name: KernelSU-rooted-image
          path: rooted.img
